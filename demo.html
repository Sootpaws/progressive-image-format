<!doctype html>
<html>
    <head>
        <title>Progressive Image Demo</title>
        <script src="linear_loader.js"></script>
        <script src="progressive_loader.js"></script>
    </head>
    <body>
        <h1>Progressive Image Demo</h1>
        <script>
            function wait(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            const transform = {
                async transform(chunk, controller) {
                    let prev_time = Date.now();
                    chunk = await chunk;
                    let i = 0;
                    while (i < chunk.length) {
                        let now = Date.now();
                        let elapsed = (now - prev_time) / 1000;
                        prev_time = now;
                        const length = Math.round(elapsed * this.bandwidth * 1024);
                        const end = Math.min(i + length, chunk.length);
                        const subchunk = chunk.slice(i, end);
                        controller.enqueue(subchunk);
                        i += length;
                        await wait(0);
                    }
                }
            };
            class BandwidthLimiter extends TransformStream {
                constructor(bandwidth) {
                    super({ ...transform, bandwidth });
                }
            }
        </script>
        <script>
            const demos = [{
                name: "Bandwidth limits",
                display: bandwidth_limit,
            }, {
                name: "Test images",
                display: html_image,
            }, {
                name: "Linear loading",
                display: linear_load,
            }, {
                name: "Progressive loading",
                display: progressive_load,
            }];

            const images = [{
                url: "demo_images/complex_photo.jpg",
                width: 200,
                height: 150,
                bandwidth: 10,
                sharp: false
            }, {
                url: "demo_images/simple_photo.jpg",
                width: 200,
                height: 150,
                bandwidth: 10,
                sharp: false
            }, {
                url: "demo_images/pixel_art.png",
                width: 200,
                height: 200,
                bandwidth: 1,
                sharp: true
            }];

            async function bandwidth_limit(img) {
                return document.createTextNode(img.bandwidth + " KiB/s");
            }

            async function html_image(img) {
                let e = document.createElement("img");
                e.src = img.url;
                e.width = img.width;
                e.height = img.height;
                if (img.sharp) e.className = "sharp";
                return e;
            }

            async function setup_loader(img, ext, loader) {
                let url = img.url.split(".");
                url.pop();
                url = url.join(".") + ext;
                let request = await fetch(url);
                if (!request.ok) {
                    return document.createTextNode("Could not fetch " + url);
                }
                let stream = request.body.pipeThrough(new BandwidthLimiter(img.bandwidth));
                let l = new loader(stream, img.width, img.height);
                l.canvas.className = "loading";
                l.complete.then(() => l.canvas.className = "complete");
                return l.canvas;
            }

            async function linear_load(img) {
                return setup_loader(img, ".sif", LinearLoader);
            }

            async function progressive_load(img) {
                return setup_loader(img, ".psi", ProgressiveLoader);
            }

            async function demo() {
                let demo_table = document.createElement("table");
                for (demo of demos) {
                    let demo_row = document.createElement("tr");
                    let cell = document.createElement("td");
                    cell.appendChild(document.createTextNode(demo.name));
                    demo_row.appendChild(cell);
                    for (image of images) {
                        let cell = document.createElement("td");
                        cell.appendChild(await demo.display(image));
                        demo_row.appendChild(cell);
                    }
                    demo_table.appendChild(demo_row);
                }
                document.body.appendChild(demo_table);
            }
            demo()
        </script>
        <style>
            .sharp {
                image-rendering: pixelated;
            }

            .loading {
                border: 2px solid red;
            }

            .complete {
                border: 2px solid green;
            }
        </style>
    </body>
</html>
