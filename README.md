# Progressive Streamable Image Format

## Overview

Progressive Streamable Image (or PSI) is a proof-of-concept lossless image
format that allows the image to be displayed at progressively higher resolutions
while being loaded. This prevents the "dial-up" effect where media loads from
top to bottom, potentially hiding more relevant portions until the top part
loads. Additionally, if the image is being displayed at a significantly lower
resolution to the source data, loading can be stopped or deprioritized once the
image has been loaded to a high-enough resolution, potentially saving a
significant amount of unneeded data transfer.

## Running the Demo

- Dependencies:
    - `make`
    - `python3`
    - The `pillow` Python library
    - An HTTP server such as `miniserve`
- Procedure:
    - Install all dependencies
    - Run `make images` to generate PSI and SIF encodings of each image
    - Serve the contents of this repository of HTTP and open `demo.html` in a
        web browser
- Using `psitool.py`:
    - Usage: `python3 psitool.py <image path>`
    - Encodes the given image into PSI and SIF formats, and write them to files
        with the same path but with `.psi` and `.sif` extensions

## Prior Work

The Progressive JPEG format appears to be a reasonable implementation of this
concept, however it is a lossy format.

## Concept

Rather than directly encode the pixel data, PSI represents the image as a series
of *layers* of approximately doubling resolution, and only stores the
*difference* between progressive layers. These are stored from smallest to
largest, and then successively applied to reconstruct the original image. Each
layer is half the size of the previous (rounded up), and each block of four
pixels on the layer are diffed to the single pixel that they replace on the
previous layer. Each diff value is generated by subtracting the pixel on the
current layer from the one on the previous one, adding `0x7f`, and clamping to
`0..255`.

## Binary Format

Header:
- Magic (4 bytes): `0x00 0x50 0x53 0x49` - `\0PSI` in ASCII
- Full width (BE u16) - Width of the full image in pixels
- Full height (BE u16) - Height of the full image in pixels
- Layer diffs:
    - Layer header (1 byte) - `M` in ASCII
    - Pixels (left to right, top to bottom):
        - Pixel diff in RGBA order, 1 byte per channel

## Simple Image Format

SIF is just about the simplest and most inefficient bitmap image format
possible, and is used here as a baseline to compare against.
The format is as follows:

Header:
- Full width (BE u16) - Width of the full image in pixels
- Full height (BE u16) - Height of the full image in pixels
- Pixels (left to right, top to bottom):
    - Pixel value in RGBA order, 1 byte unsigned per channel

## Comparisons

Full file size:
|  Format  | Complex Photo | Simple Photo | Pixel Art | Many Dots |
| -------- | ------------- | ------------ | --------- | --------- |
| Standard |   ~6.6 MiB    |   ~980 KiB   |  ~670 B   |  ~870 B   |
|   SIF    |    ~46 MiB    |    ~30 MiB   | ~4.0 KiB  | ~160 KiB  |
|   PSI    |    ~62 MiB    |    ~41 MiB   | ~5.3 KiB  | ~200 KiB  |

Loaded file size:
|  Format  | Complex Photo | Simple Photo | Pixel Art | Many Dots |
| -------- | ------------- | ------------ | --------- | --------- |
| Standard |   ~6.6 MiB    |   ~980 KiB   |  ~670 B   |  ~870 B   |
|   SIF    |    ~46 MiB    |    ~30 MiB   | ~4.0 KiB  | ~160 KiB  |
|   PSI    |   ~250 Kib    |   ~160 KiB   | ~5.3 KiB  | ~200 KiB  |

Time to show meaningful content:
|  Format  | Complex Photo | Simple Photo | Pixel Art | Many Dots |
| -------- | ------------- | ------------ | --------- | --------- |
| Standard |     ~10 m     |    ~1.5 m    |    0.5 s  |    ~1 s   |
|   SIF    |     >15 m     |     >15 m    |    ~4 s   |   ~13 s   |
|   PSI    |     ~6 s      |     ~3 s     |    ~6 s   |    ~6 s   |

Notes:
- Images were rendered at 200 pixels wide.
- "Standard" format was JPEG for Complex Photo and Simple Photo, and PNG for
    Pixel Art and Many Dots.
- "Time to show meaningful content" is subjective and heavily dependent on the
    images chosen to compare over, but the differences are large enough to still
    be meaningful.
- For the "Time to show meaningful content" data, a bandwidth limit of 10 KiB/s
    was used for Complex Photo and Simple Photo, and a limit of 1 KiB/s for
    Pixel Art and Many Dots. Standard format times were calculated from the file
    size and transfer rate, SIF and PSI were timed using a bandwidth limiter.

## Analysis

- Standard formats have much smaller file sizes than SIF or PSI, and PSI has an
    approximately 35% overhead compared to SIF
- For images displayed at resolutions greater than their original size (Pixel
    Art, Many Dots), standard formats load much faster and use less data. PSI
    has a slight advantage over SIF for time to meaningful content, but uses
    slightly more data.
- For images displayed at significantly reduced resolutions, PSI is much faster
    than both SIF and standard formats. However, this scenario may not be that
    common, as images are commonly pre-processed to allow clients to select from
    a range of resolutions.

## Limitations

As this is only a proof-of-concept, there are numerous areas of potential
improvement. The most notable are as follows:

- Implementation
    - Resizability of rendered images - Images are rendered to a preset
        resolution and cannot be loaded further if the image scale is increased
    - Performance - Both the encoding and decoding/rendering have extremely poor
        performance, and could be significantly optimized
    - Integration - The Javascript rendering system is difficult integrate into
        a standard webpage
- Analysis
    - Limited range of comparison samples - Although the images chosen for the
        demo and efficiency comparison are intended to cover a broad range of
        scenarios, an analysis of potential gains in a real-world environment
        would be much more conclusive
- Format
    - Fixed pixel format - All images are 8 bits per channel RGBA, but other
        formats exist and supporting them should be considered
    - No additional metadata - Most image formats support metadata for
        properties like color space, which are not currently part of
        the PSI format
    - No compression - Standard formats employ data compression algorithms to
        reduce data size, which could be applied
